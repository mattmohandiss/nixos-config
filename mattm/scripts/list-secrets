#!/usr/bin/env bash

collection="/org/freedesktop/secrets/collection/login"

# Extract the array of object paths using sed to parse D-Bus output
item_paths=$(gdbus call --session \
  --dest org.freedesktop.secrets \
  --object-path "$collection" \
  --method org.freedesktop.DBus.Properties.Get \
  org.freedesktop.Secret.Collection Items 2>/dev/null | \
  sed -E "s/^\(<\[objectpath //; s/\]>,\)$//; s/', '/\n/g; s/^'//; s/'$//")

# Check if we got any paths
if [ -z "$item_paths" ]; then
  echo "No secrets found or unable to access secret service"
  exit 1
fi

# Loop through and print detailed information for each secret
while IFS= read -r path; do
  if [ -n "$path" ]; then
    # Get the label
    label=$(gdbus call --session \
      --dest org.freedesktop.secrets \
      --object-path "$path" \
      --method org.freedesktop.DBus.Properties.Get \
      org.freedesktop.Secret.Item Label 2>/dev/null | \
      sed -E "s/^\(<'//; s/'>,\)$//")
    
    # Get the attributes
    attributes_raw=$(gdbus call --session \
      --dest org.freedesktop.secrets \
      --object-path "$path" \
      --method org.freedesktop.DBus.Properties.Get \
      org.freedesktop.Secret.Item Attributes 2>/dev/null)
    
    # Parse attributes from D-Bus format
    attributes=$(echo "$attributes_raw" | \
      sed -E "s/^\(<\{//; s/\}>,\)$//; s/', '/\n/g" | \
      sed -E "s/^'//; s/': '/ /g; s/'$//")
    
    echo "Label: $label"
    
    if [ -n "$attributes" ]; then
      echo "Attributes:"
      
      while IFS= read -r attr_line; do
        if [ -n "$attr_line" ]; then
          key=$(echo "$attr_line" | cut -d' ' -f1)
          value=$(echo "$attr_line" | cut -d' ' -f2-)
          # Skip the xdg:schema attribute as it's not needed for lookup
          if [ "$key" != "xdg:schema" ]; then
            echo "  $key \"$value\""
          fi
        fi
      done <<< "$attributes"
    else
      echo "No attributes found"
    fi
    
    echo ""
  fi
done <<< "$item_paths"
