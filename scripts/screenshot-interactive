#!/usr/bin/env bash

# Streamlined screenshot script
# - Saves a tidy PNG to /tmp
# - By default copies the file path to the clipboard (text/plain) so keyboard paste works
# - Use --raw to copy raw image bytes (image/png) instead
# - Prints short timestamped logs to the console

set -euo pipefail

log() {
  printf '%s %s\n' "$(date --iso-8601=seconds)" "$*"
}

# Parse optional flag
raw=0
if [ "${1:-}" = "--raw" ]; then
  raw=1
fi

# Tidy timestamped filename in /tmp
file="/tmp/screenshot-$(date +%F_%H-%M-%S).png"
log "Starting screenshot -> $file (pid $$ user $(id -un))"

# Capture area
if ! grim -g "$(slurp)" "$file"; then
  log "grim/slurp failed"
  notify-send "Screenshot Failed" "Could not take screenshot" --icon=dialog-error
  exit 1
fi

size=$(stat -c%s "$file" 2>/dev/null || echo 0)
log "Saved screenshot $file (size: ${size} bytes)"

# Notify (non-blocking)
filename=$(basename "$file")
notify-send "Screenshot Saved" "$filename" --icon=camera-photo --category=screenshot --expire-time=4000 &

# Default behavior: copy path so Ctrl+Shift+V inserts the file path into apps like opencode
if [ "$raw" -eq 1 ]; then
  if wl-copy --type image/png < "$file"; then
    log "wl-copy image/png success"
    notify-send "Screenshot Saved" "PNG placed on clipboard" --icon=camera-photo --expire-time=2000 &
  else
    log "wl-copy image/png failed"
    notify-send "Screenshot Saved" "Saved: $filename (could not copy raw PNG)" --icon=camera-photo --expire-time=2000 &
  fi
else
  if echo -n "$file" | wl-copy --type 'text/plain;charset=utf-8'; then
    log "wl-copy text/plain success"
  else
    log "wl-copy text/plain failed"
    notify-send "Screenshot Saved" "Saved: $filename (could not copy path to clipboard)" --icon=camera-photo --expire-time=2000 &
  fi
fi

log "Done: $file"

echo "Screenshot saved: $file"

